# 操作系统-Part9

## 31、OS什么时候会进行内存的交换？

内存交换通常在许多进程运行且内存吃紧时进行，而系统负荷降低就暂停。例如：在发现许多进程运行时经常发生缺页，就说明内存紧张，此时可以换出一些进程；如果缺页率明显下降，就可以暂停换出。

## 32、终端退出，终端运行的进程会怎样？

终端在退出时会发送SIGHUP给对应的bash进程，bash进程收到这个信号后首先将它发给session下面的进程，如果程序没有对SIGHUP信号做特殊处理，那么进程就会随着终端关闭而退出。

## 33、如何让进程在后台运行

- 命令后面加上 `&`即可，实际上，就是将命令放入到一个作业队列中
- `ctrl+z`挂起进程，使用 `jobs`查看序号，在使用 `bg %`序号后台运行进程
- `nohup+&`，将标准输出和标准错误缺省会被重定向到 `nohup.out`文件中，忽略所有挂断（SIGHUP）信号。
- 运行指令前面+ `setsid`，使其父进程编程 `init`进程，不受 `HUP`信号的影响
- 将命令 + `&`放在()括号中，也可以是进程不受HUP信号的影响。

## 34、什么是快表？讲一下你对于快表的了解

快表，又称联想寄存器（TLB），是一种访问速度比内存快很多的高速缓冲存储器，用来存放当前访问的若干页表项，以加速地址变换的过程，与此对应，内存中的页表常称为慢表。

![image-20230412080943710](https://happygoing.oss-cn-beijing.aliyuncs.com/img/image-20230412080943710.png)

## 35、地址变换中，有快表和没快表，有什么区别？

|                        | 地址变换过程                                                 | 访问一个逻辑地址的访存次数                     |
| ---------------------- | ------------------------------------------------------------ | ---------------------------------------------- |
| 基本地址变换机构       | ①算页号、页内偏移量 ②检查页号合法性 ③查页表，找到页面存放的内存块号 ④根据内存块号与页内偏移量得到物理地址 ⑤访问目标内存单元 | 两次访存                                       |
| 具有快表的地址变换机构 | ①算页号、页内偏移量 ②检查页号合法性 ③查快表。若命中，即可知道页面存放的内存块号，可直接进行⑤;若未命中则进行④ ④查页表，找到页面存放的内存块号，并且将页表项复制到快表中 ⑤根据内存块号与页内偏移量得到物理地址 ⑥访问目标内存单元 | 快表命中，只需一次访存快表未命中，需要两次访存 |
|                        |                                                              |                                                |

## 36、在执行malloc申请内存的时候，操作系统是怎么做的？

从操作系统层面上看，malloc是通过两个系统调用来实现的：brk和mmap

- brk是将进程数据段（.data）的最高地址指针向高出移动，这一步可以扩大进程在运行时的堆大小
- mmap是在进程的虚拟地址空间中寻找一块空闲的虚拟内存，这一步可以获得一块可以操作的堆内存。

通常，分配的内存小于128K时，使用brk调用来获得虚拟内存，大于128k时就使用mmap来获得虚拟内存。

进程先通过这两个系统调用获取或者扩大进程的虚拟内存，获得相应的虚拟地址，在访问这些虚拟地址的时候，通过缺页中断，让内核分配相应的物理内存，这样内存分配才算完成。